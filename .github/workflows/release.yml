name: Release

# on:
#   schedule:
#     # * is a special character in YAML so you have to quote this string
#     - cron: "5 * * * *"
on: [push, workflow_dispatch]

jobs:
  release:
    name: Release

    runs-on: ${{matrix.os}}
    
    strategy:
      fail-fast: false
      matrix:
        node: [lts]
        os: [ubuntu-latest, macOS-12, windows-latest]

    steps:

      - name: init
        uses: actions/checkout@v1

      - name: set python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8" 
      
      - name: set node
        uses: actions/setup-node@v2
        with:
          node-version: ${{matrix.node}} #lts/*

      - name: clone
        env:
          sha: ${{steps.sha.outputs.value}} 
        run: |
          ls -alF
          rm -rf *
          rm -rf .git
          rm -rf .github
          ls -alF
          git clone -b main --depth 1 ${{secrets.GIT_ADDRESS}} .
        shell: bash
        
      - name: install
        run: npm i
        
#       - name: brew install
#         run: brew install rpm
        
      - name: build
        run: npm run build #:all

      - name: get package version
        id: package
        uses: Ireoo/get-package@v1
        with:
          path: ./package.json
          key: version

      - name: Upload Prerelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: test_v${{steps.package.outputs.version}}
          name: test_v${{steps.package.outputs.version}}
          draft: false
          prerelease: true
          fail_on_unmatched_files: false
          append_body: true
          files: |
            build/*.exe
            build/*.msi
            build/latest.yml
            build/*.dmg
            build/*.zip
            build/*.AppImage
            build/*.pkg
            build/latest-mac.yml
            build/*.deb
            build/*.rpm
            build/*.apk
            build/latest-linux.yml
